# 코드 리뷰 및 리팩토링 중간 보고서 (2024-08-26)

## 1. 개요

프로젝트의 전반적인 구조와 기술 스택은 매우 현대적이고 훌륭합니다. (Spring Boot, Kotlin, JPA, Kafka, ELK, Coroutines 등)

하지만 코드 리뷰 결과, **핵심 모듈들(`user`, `analysis`, `notification`, `collector`)에 데이터 영속성(Persistence)이 전혀 구현되어 있지 않은 치명적인 문제**를 발견했습니다. 모든 데이터가 일회성 인메모리(In-Memory) 방식으로만 관리되고 있어, 애플리케이션 재시작 시 모든 데이터가 유실되는 상태였습니다.

이에 따라, 발견된 문제들을 해결하며 코드 리뷰를 병행하는 리팩토링 작업을 진행 중입니다.

---

## 2. 공통적으로 발견된 핵심 문제: 인메모리(In-Memory) 데이터 관리

- **현황:** `user`, `analysis`, `notification` 모듈의 서비스 클래스와 `collector` 모듈의 체크포인트 리포지토리가 모두 `ConcurrentHashMap`을 사용하여 데이터를 메모리에만 저장하고 있었습니다.
- **문제점:**
    1.  **데이터 전체 유실:** 애플리케이션 재시작 시 사용자 정보, 분석 프로필, 동기화 기록 등 모든 데이터가 소멸됩니다.
    2.  **핵심 기능 불능:** 데이터 동기화 중단 시 작업을 재개하는 '사가(Saga) 복구' 기능이 동작할 수 없습니다.
    3.  **확장 불가:** 서버를 여러 대로 증설하는 분산 환경에서 상태를 공유할 수 없어 정상 동작이 불가능합니다.

---

## 3. 리팩토링 진행 상황

상기의 치명적인 문제를 해결하기 위해 아래와 같이 영속성 계층 리팩토링을 진행했습니다.

### ✅ `user`, `analysis`, `notification` 모듈 (핵심 도메인)

- **문제점:** 영속성 계층 부재 및 모듈 간 타입 불일치(`String` vs `UUID`).
- **조치 사항:**
    1.  **JPA 엔티티 전환/생성:** 각 모듈의 핵심 모델(`User`, `AnalysisProfile`, `NotificationSettings`)을 `@Entity`로 변환하거나 신규 생성했습니다. MSA 환경을 고려하여 기본 키는 `UUID`로 통일했습니다.
    2.  **Spring Data JPA 리포지토리 전환/생성:** 각 엔티티에 대한 `JpaRepository` 인터페이스를 생성하여, 별도의 구현체 없이 DB 연동이 가능하도록 수정했습니다.
    3.  **서비스 계층 리팩토링:** 모든 서비스 클래스에서 인메모리 로직을 전부 제거하고, JPA 리포지토리를 주입받아 모든 데이터 처리를 위임하도록 수정했습니다. `@Transactional`을 적용하여 데이터 정합성을 보장했습니다.

### ✅ 통합 테스트 코드 (사용자 등록 기능)

- **문제점:** `UserRegistrationSagaTest`가 리팩토링 이전의 인메모리 서비스에 의존하고 있어 완전히 동작하지 않는 상태였음.
- **조치 사항:**
    1.  **`@SpringBootTest` 기반으로 재구성:** 테스트 환경을 실제 DB(테스트용 H2)와 연동하도록 재구성하고, `@Transactional`을 통해 테스트 간 격리성을 확보했습니다.
    2.  **DB 상태 직접 검증:** 서비스의 응답 값만 확인하는 대신, 각 리포지토리를 직접 주입받아 DB에 데이터가 올바르게 저장/삭제되었는지 직접 검증하도록 변경하여 테스트의 신뢰도를 높였습니다.

---

## 4. 현재까지 파악된 추가 개선 필요 사항

- **`collector` 모듈의 영속성 부재 (매우 시급):**
    - `DataSyncCheckpointRepository`가 인메모리로 구현되어 있어, 데이터 동기화 실패 시 복구 기능이 동작하지 않습니다. **DB나 Redis를 이용한 영속화가 시급합니다.**

- **테스트 코드의 불완전한 커버리지 (기술 부채):**
    - `UserRegistrationSagaTest`를 리팩토링하면서, 사가(Saga)의 중간 단계 실패 시나리오(예: 분석 프로필 생성 실패)에 대한 테스트를 임시로 주석 처리했습니다.
    - 이 부분은 MockK의 `@MockkBean`을 사용하여 특정 서비스가 의도적으로 예외를 던지도록 만드는 Mocking 기법을 적용해야만 완전한 테스트가 가능합니다. **이는 추후 반드시 보완해야 할 기술 부채입니다.**

- **코루틴 내 블로킹(Blocking) 호출:**
    - `RateLimitHandlerImpl`에서 재시도 대기를 위해 코루틴 환경임에도 `Thread.sleep()`을 사용하고 있습니다. 이는 비동기 처리의 이점을 상쇄하므로, 논블로킹 방식의 `delay()`로 변경해야 합니다.

- **하드코딩된 설정 값:**
    - 재시도 횟수, 배치 사이즈 등 운영 중에 변경될 수 있는 값들이 코드에 하드코딩되어 있습니다. `application.yml`을 통해 외부 설정으로 분리해야 합니다.

---

## 5. 다음 단계 ✅ **업데이트 완료 (2024-08-26)**

**⚠️ 전체 코드베이스 재검토 결과, 문제 규모가 예상보다 훨씬 큽니다.**

### **🔍 추가 발견된 문제점**
- **총 15개 인메모리 구현체** 발견 (기존 파악된 것의 3배)
- **9개 모듈**에서 `ConcurrentHashMap` 사용 확인
- **StudyGroup, Analysis, Notification 모듈** 전체가 인메모리 상태
- **코루틴 블로킹 호출**, **테스트 패턴 문제** 등 추가 기술 부채 확인

### **📋 종합 리팩토링 계획서 작성**
상세한 5단계 리팩토링 계획을 별도 문서로 작성했습니다:
👉 **`RefactoringPlan-2024-08-26-Comprehensive.md`**

### **🎯 최우선 작업 (Phase 1)**
1.  **Collector 모듈 완전 영속화**: `DataSyncCheckpointRepository`, `SubmissionRepository`, `SubmissionSyncService` 등
2.  **SAGA 복구 기능 복원**: 프로덕션 데이터 유실 위험 즉시 해결
3.  **예상 소요 시간**: 2-3일

**→ 다음 단계는 종합 계획서를 참고하여 Phase 1부터 순차 진행**
